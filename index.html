<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InHaus BI | Dashboard Financiero & Comercial</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 900: '#0f172a', 800: '#1e293b', 700: '#334155', 600: '#475569' },
                        bi: { primary: '#2563eb', success: '#10b981', warning: '#f59e0b', danger: '#ef4444', info: '#06b6d4' }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .card { background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); transition: all 0.2s; border: 1px solid #e2e8f0; }
        .card:hover { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .kpi-value { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.025em; }
        .kpi-label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: #64748b; letter-spacing: 0.05em; }
        .chart-container { position: relative; height: 100%; width: 100%; }
        /* Scrollbar custom */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .chip { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; cursor: pointer; }
        .chip-active { background-color: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }
    </style>
</head>
<body class="text-slate-800">

    <header class="bg-brand-900 text-white sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <div class="bg-bi-primary p-2 rounded-lg">
                        <i class="fa-solid fa-chart-pie text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold tracking-tight">INHAUS <span class="text-slate-400 font-light">| BI SUITE</span></h1>
                        <p class="text-xs text-slate-400">Control Financiero & Comercial</p>
                    </div>
                </div>

                <div class="flex flex-wrap gap-2 items-center">
                    <label class="bg-brand-700 hover:bg-brand-600 px-4 py-2 rounded text-xs font-medium cursor-pointer transition flex items-center gap-2 border border-brand-600">
                        <i class="fa-solid fa-upload"></i> Subir CSV
                        <input type="file" id="csvInput" accept=".csv" class="hidden">
                    </label>
                    <button onclick="loadDemoData()" class="bg-transparent hover:bg-brand-800 border border-brand-600 px-3 py-2 rounded text-xs font-medium transition">
                        <i class="fa-solid fa-database"></i> Demo
                    </button>
                    <button onclick="resetFilters()" class="bg-bi-danger hover:bg-red-600 text-white px-3 py-2 rounded text-xs font-medium transition hidden" id="resetBtn">
                        <i class="fa-solid fa-filter-circle-xmark"></i> Limpiar Filtros
                    </button>
                    <button onclick="exportData()" class="bg-bi-success hover:bg-green-600 text-white px-3 py-2 rounded text-xs font-medium transition">
                        <i class="fa-solid fa-file-excel"></i> Exportar
                    </button>
                </div>
            </div>
            
            <div class="mt-4 pt-3 border-t border-brand-800 flex flex-wrap gap-3" id="filterContainer">
                <div class="text-xs text-slate-500 italic py-1">Cargando filtros...</div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6 space-y-6">

        <div id="insightsPanel" class="grid grid-cols-1 md:grid-cols-4 gap-4 hidden">
            </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
            <div class="card p-4 border-l-4 border-bi-primary">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="kpi-label">Venta Total (Precio Final)</p>
                        <h3 class="kpi-value text-bi-primary" id="kpi-total-sales">$0</h3>
                        <p class="text-xs text-slate-500 mt-1"><span id="kpi-count-ops">0</span> Operaciones</p>
                    </div>
                    <i class="fa-solid fa-sack-dollar text-bi-primary opacity-20 text-3xl"></i>
                </div>
            </div>

            <div class="card p-4 border-l-4 border-bi-success">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="kpi-label">Ingreso Real (Cobrado)</p>
                        <h3 class="kpi-value text-bi-success" id="kpi-collected">$0</h3>
                        <p class="text-xs text-slate-500 mt-1" id="kpi-collected-pct">0% del total</p>
                    </div>
                    <i class="fa-solid fa-cash-register text-bi-success opacity-20 text-3xl"></i>
                </div>
            </div>

            <div class="card p-4 border-l-4 border-bi-warning">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="kpi-label">Por Cobrar (Cartera)</p>
                        <h3 class="kpi-value text-bi-warning" id="kpi-receivable">$0</h3>
                        <p class="text-xs text-slate-500 mt-1">En proceso operativo</p>
                    </div>
                    <i class="fa-solid fa-file-invoice-dollar text-bi-warning opacity-20 text-3xl"></i>
                </div>
            </div>

            <div class="card p-4 border-l-4 border-bi-danger">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="kpi-label">Venta Cancelada</p>
                        <h3 class="kpi-value text-bi-danger" id="kpi-cancelled">$0</h3>
                        <p class="text-xs text-slate-500 mt-1" id="kpi-cancelled-pct">0% Tasa de Fuga</p>
                    </div>
                    <i class="fa-solid fa-ban text-bi-danger opacity-20 text-3xl"></i>
                </div>
            </div>

            <div class="card p-4 border-l-4 border-purple-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="kpi-label">Comisiones Totales</p>
                        <h3 class="kpi-value text-purple-600" id="kpi-commissions">$0</h3>
                        <p class="text-xs text-slate-500 mt-1">Generadas por ventas</p>
                    </div>
                    <i class="fa-solid fa-hand-holding-dollar text-purple-500 opacity-20 text-3xl"></i>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-96">
            <div class="card p-5 flex flex-col">
                <div class="flex justify-between mb-4">
                    <h3 class="font-bold text-slate-700"><i class="fa-solid fa-sitemap mr-2"></i>Desempeño por Gerencia</h3>
                    <span class="text-xs bg-slate-100 px-2 py-1 rounded">Volumen Venta</span>
                </div>
                <div class="chart-container flex-1">
                    <canvas id="chartGerencia"></canvas>
                </div>
            </div>

            <div class="card p-5 flex flex-col">
                <div class="flex justify-between mb-4">
                    <h3 class="font-bold text-slate-700"><i class="fa-solid fa-coins mr-2"></i>Estatus Financiero por Gerencia</h3>
                    <span class="text-xs bg-slate-100 px-2 py-1 rounded">Cobrado vs Por Cobrar</span>
                </div>
                <div class="chart-container flex-1">
                    <canvas id="chartFinanceStack"></canvas>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-80">
            <div class="card p-5 flex flex-col md:col-span-1">
                <h3 class="font-bold text-slate-700 mb-2 text-sm">Top Proyectos</h3>
                <div class="chart-container flex-1">
                    <canvas id="chartProjects"></canvas>
                </div>
            </div>

            <div class="card p-5 flex flex-col md:col-span-1">
                <h3 class="font-bold text-slate-700 mb-2 text-sm">Salud de Cartera (Estatus)</h3>
                <div class="chart-container flex-1 flex justify-center">
                    <canvas id="chartStatus"></canvas>
                </div>
            </div>

            <div class="card p-5 flex flex-col md:col-span-1">
                <h3 class="font-bold text-slate-700 mb-2 text-sm">Top 5 Asesores</h3>
                <div class="chart-container flex-1">
                    <canvas id="chartAgents"></canvas>
                </div>
            </div>
        </div>

        <div class="card overflow-hidden">
            <div class="p-4 border-b bg-slate-50 flex flex-col md:flex-row justify-between items-center gap-4">
                <h3 class="font-bold text-slate-700"><i class="fa-solid fa-table-list mr-2"></i>Detalle de Operaciones</h3>
                <div class="flex gap-2 w-full md:w-auto">
                    <input type="text" id="tableSearch" placeholder="Buscar cliente, folio..." class="border rounded px-3 py-1.5 text-sm w-full md:w-64 focus:outline-none focus:border-bi-primary">
                </div>
            </div>
            <div class="overflow-x-auto max-h-[500px]">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-100 text-xs uppercase text-slate-500 sticky top-0 z-10">
                        <tr>
                            <th class="px-4 py-3 cursor-pointer hover:bg-slate-200" onclick="sortTable('fecha')">Fecha <i class="fa-solid fa-sort"></i></th>
                            <th class="px-4 py-3 cursor-pointer hover:bg-slate-200" onclick="sortTable('gerencia')">Gerencia <i class="fa-solid fa-sort"></i></th>
                            <th class="px-4 py-3">Cliente / Proyecto</th>
                            <th class="px-4 py-3">Asesor</th>
                            <th class="px-4 py-3 text-right cursor-pointer hover:bg-slate-200" onclick="sortTable('precio')">Precio Final <i class="fa-solid fa-sort"></i></th>
                            <th class="px-4 py-3 text-center">Financiero</th>
                            <th class="px-4 py-3 text-center">Estatus</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-100">
                        </tbody>
                </table>
            </div>
            <div class="p-3 border-t bg-slate-50 text-xs text-slate-500 flex justify-between items-center">
                <span id="tableInfo">Mostrando 0 registros</span>
                <div class="flex gap-2">
                    <button onclick="changePage(-1)" class="px-3 py-1 bg-white border rounded hover:bg-slate-100">Anterior</button>
                    <button onclick="changePage(1)" class="px-3 py-1 bg-white border rounded hover:bg-slate-100">Siguiente</button>
                </div>
            </div>
        </div>

    </main>

    <footer class="bg-brand-900 text-slate-400 py-6 text-center text-sm mt-8">
        <p>&copy; 2025 InHaus Intelligence System. Renderizado en el cliente.</p>
    </footer>

    <script>
        // ==========================================
        // 1. STATE MANAGEMENT
        // ==========================================
        const state = {
            rawData: [],
            mappedData: [],
            filteredData: [],
            filters: {
                gerencia: [],
                asesor: [],
                proyecto: [],
                estatus: []
            },
            pagination: {
                page: 1,
                rows: 50
            },
            charts: {}
        };

        // ==========================================
        // 2. DATA MAPPING & PARSING
        // ==========================================
        
        // Demo Data (Fallback)
        const demoCSV = `FECHA,GERENCIA,NOMBRE,PROYECTO,NEGOCIO,GESTOR,TELEFONO,RECURSO,APARTADO,CUENTA,ENGANCHE,VENTA,%_COMISION,$_COMISION,ESTATUS,VENDEDOR
2025-05-05,CRISTOBAL BALDERRAMA,ANA PEREZ,SAN FERNANDO,VENTA,ITZEL,6692155,COFINAVIT,30000,,0,1625000,0.04,65000,CANCELADO,ERICKA REYNOSA
2025-05-28,CRISTOBAL BALDERRAMA,HUGO MENDEZ,HACIENDA SEMINARIO,VENTA,OSCAR,6692550,INFONAVIT,30000,,0,1890000,0.025,47250,ESPERA,ERICKA REYNOSA
2025-05-05,CRISTOBAL BALDERRAMA,ELISA ZAMORA,PRADERA DORADA,VENTA,OSCAR,6692550,INFONAVIT,40000,,0,1250000,0.04,50000,OPERADO,ERICKA REYNOSA
2025-04-30,CRISTOBAL BALDERRAMA,JOHAN CONTRERAS,COLINAS REAL,VENTA,ALMA,6699202,FOVISSSTE,40000,,0,1480000,0.04,59200,OPERADO,VALERIA REYNOSA
2025-05-29,CRISTOBAL BALDERRAMA,VIVIANA CASTRO,SONTERRA LOTE,VENTA,OSCAR,6692550,,50000,VICTOR,0,1340000,0.05,67000,OPERADO,VALERIA REYNOSA
2025-08-15,CRISTOBAL BALDERRAMA,RICARDO PARRA,PLAZA BOCANEGRA,VENTA,VICTOR,6691060,CONTADO,50000,GUADALUPE,0,3513320,0.05,175666,OPERANDO,PAOLA SARABIA
2025-10-03,CRISTOBAL BALDERRAMA,ALAIN OSUNA,PLAZA BOCANEGRA,VENTA,VICTOR,6691060,CONTADO,50000,GUADALUPE,0,1984000,0.05,99200,POR COBRAR,CRISTOBAL BALDERRAMA
2025-11-24,OBED HUMARÁN,SARAH CORRAL,SONTERRA,VENTA,SIN,0,DIRECTO,305289,,381121,1526448,0.02,30528,POR COBRAR,VALERIA REYNOSA
2025-11-28,OBED HUMARÁN,ROLDAN ORTIZ,SUNSET HILLS,VENTA,SIN,0,HIPOTECARIO,100000,,300000,4100000,0.025,102500,POR COBRAR,ERICKA REYNOSA
2025-12-05,OBED HUMARÁN,NORMA AYON,SUNSET HILLS,APARTADO,SIN,0,CONTADO,50000,,,2343250,0.04,93730,ESPERA,ERICKA REYNOSA
2025-12-10,OBED HUMARÁN,IVAN MORALES,PLAZA BOCANEGRA,APARTADO,VICTOR,0,CONTADO,100000,,,2224000,0.05,111200,ESPERA,ERICKA REYNOSA`;

        function parseCurrency(value) {
            if (typeof value === 'number') return value;
            if (!value) return 0;
            return parseFloat(value.toString().replace(/[$,]/g, '')) || 0;
        }

        function mapData(data) {
            return data.map(row => {
                // Heuristic Mapping based on provided CSV structure
                const precio = parseCurrency(row['VENTA'] || row['PRECIO'] || 0);
                const estatus = (row['ESTATUS'] || row['ESTATUS_VENTA'] || 'Desconocido').toUpperCase().trim();
                const apartado = parseCurrency(row['APARTADO']);
                const enganche = parseCurrency(row['ENGANCHE']);
                
                // Financial Logic
                let cobrado = 0;
                let cancelado = 0;
                let porCobrar = 0;

                if (estatus.includes('CANCEL')) {
                    cancelado = precio;
                    cobrado = 0; // Assume refunded or lost
                } else if (estatus.includes('OPERADO') || estatus.includes('ENTREGADO') || estatus.includes('PAGADO')) {
                    cobrado = precio;
                } else {
                    // In process (Apartado, Espera, Por cobrar)
                    cobrado = apartado + enganche;
                    porCobrar = Math.max(0, precio - cobrado);
                }

                return {
                    fecha: row['FECHA'] || row['fecha_cierre'] || '2025-01-01',
                    gerencia: row['GERENCIA'] || row['gerencia'] || 'Sin Asignar',
                    cliente: row['NOMBRE'] || row['cliente'] || 'Anónimo',
                    proyecto: row['PROYECTO'] || row['proyecto'] || 'General',
                    asesor: row['VENDEDOR'] || row['asesor'] || 'Oficina',
                    estatus: estatus,
                    precio: precio,
                    comision: parseCurrency(row['$_COMISION'] || row['COMISION'] || 0),
                    cobrado: cobrado,
                    porCobrar: porCobrar,
                    cancelado: cancelado,
                    raw: row
                };
            }).filter(d => d.precio > 0 || d.estatus !== 'Desconocido'); // Filter empty rows
        }

        // ==========================================
        // 3. CORE LOGIC (Filtering & Insights)
        // ==========================================
        
        function applyFilters() {
            state.filteredData = state.mappedData.filter(item => {
                const matchGerencia = state.filters.gerencia.length === 0 || state.filters.gerencia.includes(item.gerencia);
                const matchAsesor = state.filters.asesor.length === 0 || state.filters.asesor.includes(item.asesor);
                const matchProyecto = state.filters.proyecto.length === 0 || state.filters.proyecto.includes(item.proyecto);
                const matchEstatus = state.filters.estatus.length === 0 || state.filters.estatus.includes(item.estatus);
                return matchGerencia && matchAsesor && matchProyecto && matchEstatus;
            });

            updateUI();
        }

        function toggleFilter(type, value) {
            const idx = state.filters[type].indexOf(value);
            if (idx === -1) state.filters[type].push(value);
            else state.filters[type].splice(idx, 1);
            
            // UI Feedback inside chart click (optional)
            document.getElementById('resetBtn').classList.remove('hidden');
            applyFilters();
        }

        function resetFilters() {
            state.filters = { gerencia: [], asesor: [], proyecto: [], estatus: [] };
            document.getElementById('resetBtn').classList.add('hidden');
            applyFilters();
        }

        function generateInsights(data) {
            const panel = document.getElementById('insightsPanel');
            panel.innerHTML = '';
            if (data.length === 0) return;

            // 1. Top Gerencia (Cobrado)
            const gerenciaCobro = {};
            data.forEach(d => gerenciaCobro[d.gerencia] = (gerenciaCobro[d.gerencia] || 0) + d.cobrado);
            const topG = Object.keys(gerenciaCobro).reduce((a, b) => gerenciaCobro[a] > gerenciaCobro[b] ? a : b);
            
            // 2. Cancellation Rate
            const total = data.reduce((s, d) => s + d.precio, 0);
            const cancelled = data.reduce((s, d) => s + d.cancelado, 0);
            const rate = total > 0 ? (cancelled / total) * 100 : 0;

            const cards = [
                { title: 'Líder en Cobranza', val: topG, color: 'border-l-4 border-green-500 bg-green-50' },
                { title: 'Tasa de Cancelación', val: rate.toFixed(1) + '%', color: rate > 10 ? 'border-l-4 border-red-500 bg-red-50' : 'border-l-4 border-blue-500 bg-white' },
                { title: 'Ticket Promedio', val: new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', maximumSignificantDigits: 3 }).format(total / data.length), color: 'bg-white border-l-4 border-gray-400' }
            ];

            cards.forEach(c => {
                panel.innerHTML += `
                    <div class="p-3 rounded shadow-sm ${c.color}">
                        <div class="text-xs text-slate-500 uppercase font-bold">${c.title}</div>
                        <div class="text-lg font-bold text-slate-800 truncate">${c.val}</div>
                    </div>
                `;
            });
            panel.classList.remove('hidden');
        }

        // ==========================================
        // 4. UI RENDERING
        // ==========================================

        function updateUI() {
            const data = state.filteredData;
            
            // KPIs
            const totalVenta = data.reduce((acc, r) => acc + r.precio, 0);
            const totalCobrado = data.reduce((acc, r) => acc + r.cobrado, 0);
            const totalPorCobrar = data.reduce((acc, r) => acc + r.porCobrar, 0);
            const totalCancelado = data.reduce((acc, r) => acc + r.cancelado, 0);
            const totalComision = data.reduce((acc, r) => acc + r.comision, 0);

            const fmt = (n) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(n);
            
            document.getElementById('kpi-total-sales').innerText = fmt(totalVenta);
            document.getElementById('kpi-count-ops').innerText = data.length;
            document.getElementById('kpi-collected').innerText = fmt(totalCobrado);
            document.getElementById('kpi-collected-pct').innerText = totalVenta > 0 ? ((totalCobrado/totalVenta)*100).toFixed(1) + '% del total' : '0%';
            document.getElementById('kpi-receivable').innerText = fmt(totalPorCobrar);
            document.getElementById('kpi-cancelled').innerText = fmt(totalCancelado);
            document.getElementById('kpi-cancelled-pct').innerText = totalVenta > 0 ? ((totalCancelado/totalVenta)*100).toFixed(1) + '% Tasa de Fuga' : '0%';
            document.getElementById('kpi-commissions').innerText = fmt(totalComision);

            // Filter Controls (Dynamic)
            renderFilterChips();

            // Charts
            renderCharts(data);

            // Table
            renderTable(data);

            // Insights
            generateInsights(data);
        }

        function renderFilterChips() {
            const container = document.getElementById('filterContainer');
            container.innerHTML = '';
            
            const createSelect = (key, label, icon) => {
                const uniqueVals = [...new Set(state.mappedData.map(d => d[key]))].sort();
                const wrapper = document.createElement('div');
                wrapper.className = "relative inline-block";
                
                const select = document.createElement('select');
                select.className = "bg-brand-800 border border-brand-600 text-white text-xs rounded px-2 py-1 focus:outline-none";
                select.innerHTML = `<option value="">${label}</option>` + uniqueVals.map(v => `<option value="${v}" ${state.filters[key].includes(v) ? 'selected' : ''}>${v}</option>`).join('');
                select.onchange = (e) => {
                    if(e.target.value) toggleFilter(key, e.target.value);
                };
                wrapper.appendChild(select);
                
                // Active chips
                state.filters[key].forEach(val => {
                    const chip = document.createElement('span');
                    chip.className = "ml-1 bg-bi-primary text-white text-xs px-2 py-0.5 rounded-full cursor-pointer hover:bg-red-500";
                    chip.innerText = `${val} ×`;
                    chip.onclick = () => toggleFilter(key, val);
                    wrapper.appendChild(chip);
                });
                
                container.appendChild(wrapper);
            };

            createSelect('gerencia', 'Todas las Gerencias', '');
            createSelect('asesor', 'Todos los Asesores', '');
            createSelect('proyecto', 'Todos los Proyectos', '');
            createSelect('estatus', 'Todos los Estatus', '');
        }

        // ==========================================
        // 5. CHART ENGINE
        // ==========================================

        function renderCharts(data) {
            Chart.defaults.font.family = "'Inter', sans-serif";
            Chart.defaults.color = '#64748b';

            // 1. Gerencia (Bar)
            const grData = {};
            data.forEach(d => grData[d.gerencia] = (grData[d.gerencia] || 0) + d.precio);
            createChart('chartGerencia', 'bar', Object.keys(grData), [{
                label: 'Ventas Totales',
                data: Object.values(grData),
                backgroundColor: '#3b82f6',
                borderRadius: 4
            }], (idx) => toggleFilter('gerencia', Object.keys(grData)[idx]));

            // 2. Finance Stack (Stacked Bar)
            const grLabels = Object.keys(grData);
            const stackCobrado = grLabels.map(g => data.filter(d => d.gerencia === g).reduce((s, x) => s + x.cobrado, 0));
            const stackPorCobrar = grLabels.map(g => data.filter(d => d.gerencia === g).reduce((s, x) => s + x.porCobrar, 0));
            
            createChart('chartFinanceStack', 'bar', grLabels, [
                { label: 'Cobrado', data: stackCobrado, backgroundColor: '#10b981', stack: 'Stack 0' },
                { label: 'Por Cobrar', data: stackPorCobrar, backgroundColor: '#f59e0b', stack: 'Stack 0' }
            ], (idx) => toggleFilter('gerencia', grLabels[idx]));

            // 3. Projects (Horizontal)
            const prData = {};
            data.forEach(d => prData[d.proyecto] = (prData[d.proyecto] || 0) + d.precio);
            // Sort top 5
            const sortedPr = Object.entries(prData).sort((a,b) => b[1] - a[1]).slice(0, 8);
            
            createChart('chartProjects', 'bar', sortedPr.map(x=>x[0]), [{
                label: 'Monto',
                data: sortedPr.map(x=>x[1]),
                backgroundColor: '#6366f1',
                borderRadius: 4
            }], (idx) => toggleFilter('proyecto', sortedPr[idx][0]), { indexAxis: 'y' });

            // 4. Status (Doughnut)
            const stData = {};
            data.forEach(d => stData[d.estatus] = (stData[d.estatus] || 0) + 1);
            createChart('chartStatus', 'doughnut', Object.keys(stData), [{
                data: Object.values(stData),
                backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#3b82f6', '#6366f1']
            }], (idx) => toggleFilter('estatus', Object.keys(stData)[idx]));

            // 5. Agents (Bar)
            const agData = {};
            data.forEach(d => agData[d.asesor] = (agData[d.asesor] || 0) + d.precio);
            const sortedAg = Object.entries(agData).sort((a,b) => b[1] - a[1]).slice(0, 5);
            createChart('chartAgents', 'bar', sortedAg.map(x=>x[0]), [{
                label: 'Ventas',
                data: sortedAg.map(x=>x[1]),
                backgroundColor: '#1e293b',
                borderRadius: 4
            }], (idx) => toggleFilter('asesor', sortedAg[idx][0]));
        }

        function createChart(id, type, labels, datasets, clickHandler, extraOptions = {}) {
            if(state.charts[id]) state.charts[id].destroy();
            const ctx = document.getElementById(id).getContext('2d');
            
            state.charts[id] = new Chart(ctx, {
                type: type,
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (evt, activeElements) => {
                        if (activeElements.length > 0) {
                            clickHandler(activeElements[0].index);
                        }
                    },
                    plugins: {
                        legend: { display: type === 'doughnut' || datasets.length > 1, position: 'bottom', labels: { boxWidth: 10, font: {size: 10} } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null && type !== 'pie' && type !== 'doughnut') {
                                        label += new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', maximumSignificantDigits: 3 }).format(context.parsed.y || context.parsed.x);
                                    } else {
                                        label += context.raw;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: (type === 'doughnut') ? {} : {
                        x: { grid: { display: false } },
                        y: { beginAtZero: true, ticks: { callback: (val) => val >= 1000000 ? '$' + (val/1000000).toFixed(1) + 'M' : '$' + (val/1000).toFixed(0) + 'k' } }
                    },
                    ...extraOptions
                }
            });
        }

        // ==========================================
        // 6. TABLE & UTILS
        // ==========================================

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            // Search
            const search = document.getElementById('tableSearch').value.toLowerCase();
            let tableData = data.filter(d => 
                d.cliente.toLowerCase().includes(search) || 
                d.proyecto.toLowerCase().includes(search) ||
                d.estatus.toLowerCase().includes(search)
            );

            // Pagination
            const start = (state.pagination.page - 1) * state.pagination.rows;
            const pageData = tableData.slice(start, start + state.pagination.rows);
            
            document.getElementById('tableInfo').innerText = `Mostrando ${start + 1} - ${Math.min(start + state.pagination.rows, tableData.length)} de ${tableData.length}`;

            pageData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition border-b border-slate-100";
                
                let statusColor = 'bg-gray-100 text-gray-600';
                if(row.estatus.includes('OPERADO')) statusColor = 'bg-green-100 text-green-700';
                if(row.estatus.includes('ESPERA')) statusColor = 'bg-yellow-100 text-yellow-700';
                if(row.estatus.includes('CANCEL')) statusColor = 'bg-red-100 text-red-700';
                if(row.estatus.includes('COBRAR')) statusColor = 'bg-blue-100 text-blue-700';

                tr.innerHTML = `
                    <td class="px-4 py-3 text-slate-500 font-mono text-xs">${row.fecha}</td>
                    <td class="px-4 py-3 font-semibold text-slate-700">${row.gerencia}</td>
                    <td class="px-4 py-3">
                        <div class="font-medium text-slate-800">${row.cliente}</div>
                        <div class="text-xs text-slate-400">${row.proyecto}</div>
                    </td>
                    <td class="px-4 py-3 text-slate-600">${row.asesor}</td>
                    <td class="px-4 py-3 text-right font-bold text-slate-800">${new Intl.NumberFormat('es-MX', {style:'currency', currency:'MXN'}).format(row.precio)}</td>
                    <td class="px-4 py-3 text-right">
                        <div class="text-xs text-green-600">Cob: ${new Intl.NumberFormat('es-MX', {maximumFractionDigits:0}).format(row.cobrado)}</div>
                        <div class="text-xs text-red-400">Pen: ${new Intl.NumberFormat('es-MX', {maximumFractionDigits:0}).format(row.porCobrar)}</div>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="${statusColor} px-2 py-1 rounded-full text-xs font-bold">${row.estatus}</span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function changePage(dir) {
            state.pagination.page += dir;
            if(state.pagination.page < 1) state.pagination.page = 1;
            renderTable(state.filteredData);
        }

        function sortTable(key) {
            state.filteredData.sort((a, b) => a[key] > b[key] ? 1 : -1);
            renderTable(state.filteredData);
        }

        // ==========================================
        // 7. INITIALIZATION & EXPORT
        // ==========================================

        function loadDemoData() {
            Papa.parse(demoCSV, {
                header: true,
                skipEmptyLines: true,
                complete: (res) => {
                    state.rawData = res.data;
                    state.mappedData = mapData(state.rawData);
                    applyFilters();
                }
            });
        }

        function exportData() {
            const csv = Papa.unparse(state.filteredData.map(d => ({
                FECHA: d.fecha,
                GERENCIA: d.gerencia,
                CLIENTE: d.cliente,
                PROYECTO: d.proyecto,
                PRECIO: d.precio,
                COBRADO: d.cobrado,
                POR_COBRAR: d.porCobrar,
                ESTATUS: d.estatus
            })));
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "reporte_bi_inhaus.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Listeners
        document.getElementById('csvInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (res) => {
                        state.rawData = res.data;
                        state.mappedData = mapData(state.rawData);
                        applyFilters();
                    }
                });
            }
        });

        document.getElementById('tableSearch').addEventListener('keyup', () => renderTable(state.filteredData));

        // Init
        window.onload = () => {
            // Check localstorage logic could go here
            loadDemoData(); // Auto load demo on start for impressiveness
        };

    </script>
</body>
</html>
